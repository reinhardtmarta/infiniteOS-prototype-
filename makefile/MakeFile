# ------------------------------------------------------------------------------
# Makefile para o InfiniteOS - GOLDEN RATIO QUANTUM KERNEL
# Define comandos para compilar o kernel e o bootloader.
# ------------------------------------------------------------------------------

# Configurações do Cross-Compiler (Alvo 32-bit ELF)
CC = i686-elf-gcc
AS = nasm
LD = i686-elf-ld
OBJCOPY = i686-elf-objcopy

# Flags de Compilação
CFLAGS = -Wall -Wextra -std=gnu99 -ffreestanding -O2 -g
CFLAGS += -I./include  # Inclui a pasta de cabeçalhos
LDFLAGS = -T boot/linker.ld

# Arquivos a serem compilados
C_FILES = $(wildcard src/kernel/*.c)
C_FILES += $(wildcard src/drivers/*.c)
C_OBJECTS = $(patsubst %.c, %.o, $(C_FILES))

# Nome do arquivo final do kernel
KERNEL = bin/InfiniteOS.bin

# --- Regra Principal: all ---
.PHONY: all clean

all: $(KERNEL)

# --- 1. Regra para o Kernel Final (.bin) ---
$(KERNEL): $(C_OBJECTS) boot/boot.o
	@mkdir -p bin
    	echo "-> Linking the InfiniteOS Kernel..."
        	$(LD) $(LDFLAGS) boot/boot.o $(C_OBJECTS) -o bin/kernel.elf
            	
                	# Usar objcopy para criar o arquivo .bin
                    	# Note: Este passo é avançado e dependente da arquitetura. Por agora, usamos o ELF.
                        	#$(OBJCOPY) -O binary bin/kernel.elf $(KERNEL)

                            	# Por simplicidade, vamos usar o ELF (formato de executável) para testes iniciais no QEMU
                                	mv bin/kernel.elf $(KERNEL)
                                    	echo "-> InfiniteOS Binary created: $(KERNEL)"

                                        # --- 2. Regra para Compilar Arquivos C (.c -> .o) ---
                                        %.o: %.c
                                        	@mkdir -p $(dir $@)
                                            	echo "-> Compiling C file: $<"
                                                	$(CC) $(CFLAGS) -c $< -o $@

                                                    # --- 3. Regra para o Bootloader (Assembly .asm -> .o) ---
                                                    boot/boot.o: boot/boot.asm
                                                    	echo "-> Assembling Bootloader: $<"
                                                        	$(AS) $< -f elf -o $@

                                                            # --- Regra para Limpeza ---
                                                            clean:
                                                            	@echo "-> Cleaning up build files..."
                                                                	rm -rf bin *.o src/kernel/*.o src/drivers/*.o boot/*.o
                                                                    