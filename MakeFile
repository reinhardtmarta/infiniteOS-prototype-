# ------------------------------------------------------------------------------
# Makefile para o InfiniteOS - GOLDEN RATIO QUANTUM KERNEL
# Define comandos para compilar o kernel e o bootloader.
# ------------------------------------------------------------------------------

# --- 1. CONFIGURAÇÃO DE FERRAMENTAS ---
# IMPORTANTE: Essas ferramentas (cross-compiler) devem estar instaladas
CC = i686-elf-gcc
AS = nasm
LD = i686-elf-ld
OBJCOPY = i686-elf-objcopy
QEMU = qemu-system-i386

# --- 2. VARIÁVEIS DE COMPILAÇÃO ---
CFLAGS = -Wall -Wextra -std=gnu99 -ffreestanding -O2 -g
CFLAGS += -I./include  # Inclui a pasta de cabeçalhos
LDFLAGS = -T boot/linker.ld

# Localiza todos os arquivos C nas pastas principais
C_FILES = $(wildcard src/kernel/*.c)
C_FILES += $(wildcard src/drivers/*.c)
C_FILES += $(wildcard src/lib/*.c)
C_OBJECTS = $(patsubst %.c, %.o, $(C_FILES))

# Nome do arquivo final do kernel
KERNEL = bin/InfiniteOS.bin

# --- 3. REGRAS PRINCIPAIS ---

.PHONY: all clean run

# Regra padrão: Compila tudo
all: $(KERNEL)

# Regra para compilar o kernel (bin/InfiniteOS.bin)
$(KERNEL): $(C_OBJECTS) boot/boot.o
	@mkdir -p bin
	@echo "-> Linking the InfiniteOS Kernel..."
	$(LD) $(LDFLAGS) boot/boot.o $(C_OBJECTS) -o bin/kernel.elf
	
	# Move o arquivo ELF para ser carregado pelo QEMU
	mv bin/kernel.elf $(KERNEL)
	@echo "-> InfiniteOS Binary created: $(KERNEL)"

# --- 4. REGRAS DE COMPILAÇÃO INDIVIDUAIS ---

# Regra para Compilar Arquivos C (.c -> .o)
%.o: %.c
	@mkdir -p $(dir $@)
	@echo "-> Compiling C file: $<"
	$(CC) $(CFLAGS) -c $< -o $@

# Regra para o Bootloader (Assembly .asm -> .o)
boot/boot.o: boot/boot.asm
	@echo "-> Assembling Bootloader: $<"
	$(AS) $< -f elf -o $@

# --- 5. REGRAS DE EXECUÇÃO E LIMPEZA ---

# Executa o Kernel no Emulador QEMU
run: all
	@echo "--- Executando o InfiniteOS no QEMU ---"
	$(QEMU) -fda $(KERNEL) -m 64 -cpu pentium -serial stdio -no-reboot
	@echo "--- Teste Concluído ---"

# Limpa todos os arquivos gerados
clean:
	@echo "-> Cleaning up build files..."
	rm -rf bin *.o src/kernel/*.o src/drivers/*.o src/lib/*.o boot/*.o
